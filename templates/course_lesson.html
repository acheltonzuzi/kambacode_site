{% extends "base.html" %}
{% load static %}

{% block title %}{{ course.title }} | NEMOE KAMBA CODE{% endblock %}

{% block content %}
<main class="flex flex-row-reverse h-screen bg-gray-100">

    <!-- Sidebar -->
    <aside class="w-80 bg-white border-l border-gray-200 overflow-y-auto shadow-lg">
        <div class="p-5 border-b bg-gradient-to-r from-orange-500 to-orange-600 text-white">
            <h2 class="text-lg font-bold">{{ course.title }}</h2>
            <p class="text-sm opacity-90">Instrutor: {{ course.instructor.username }}</p>
        </div>

        <!-- M√≥dulos e Li√ß√µes -->
        <div class="divide-y divide-gray-200">
            {% for module in modules %}
            <details class="group" {% if forloop.first %}open{% endif %}>
                <summary
                    class="cursor-pointer bg-gray-50 hover:bg-orange-50 px-4 py-3 flex justify-between items-center">
                    <span class="font-medium text-gray-700">{{ module.title }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4 text-gray-500 group-open:rotate-180 transition-transform" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </summary>
                <div class="bg-white divide-y divide-gray-100">
                    {% for lesson in module.lessons.all %}
                    <button
                        class="w-full text-left flex justify-between items-center px-5 py-2 text-sm hover:bg-orange-100 transition duration-200"
                        onclick="loadLesson('{{ lesson.video_url|escapejs }}', '{{ lesson.title|escapejs }}')">
                        <span class="truncate text-gray-700">{{ lesson.title }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 text-orange-400">
                            <path fill-rule="evenodd"
                                d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113Z"
                                clip-rule="evenodd" />
                        </svg>

                    </button>
                    {% empty %}
                    <p class="text-gray-500 text-sm px-5 py-2">Nenhuma aula.</p>
                    {% endfor %}
                </div>
            </details>
            {% empty %}
            <p class="text-gray-500 text-sm p-4">Nenhum m√≥dulo encontrado.</p>
            {% endfor %}
        </div>
    </aside>

    <!-- √Årea principal (Player e conte√∫do) -->
    <section class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="flex justify-between items-center bg-white px-6 py-4 border-b shadow-sm">
            <h1 id="lessonTitle" class="text-lg font-semibold text-gray-800 truncate">
                {{ course.title }}
            </h1>
            <a href="{% url 'course_detail' course_id=course.id %}"
                class="text-sm text-orange-600 hover:underline font-medium">
                ‚Üê Voltar ao curso
            </a>
        </header>

        <!-- Player de v√≠deo -->
        <div class="relative flex-1 bg-black">
            <iframe id="videoFrame" class="absolute inset-0 w-full h-full rounded-b-lg" src="" frameborder="0"
                allowfullscreen>
            </iframe>

            <!-- Tela inicial -->
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                <img src="{% static 'img/placeholder.png' %}" alt="Course Preview" class="w-64 mb-4 opacity-80">
                <p class="text-lg">Selecione uma aula para come√ßar a assistir</p>
            </div>
        </div>
    </section>
</main>

<!-- Script -->
<!-- <script>
    function loadLesson(url, title) {
        const frame = document.getElementById('videoFrame');
        const titleElement = document.getElementById('lessonTitle');
        const placeholder = document.getElementById('placeholder');

        if (url.includes("youtube.com") || url.includes("youtu.be")) {
            const embedUrl = url
                .replace("watch?v=", "embed/")
                .replace("youtu.be/", "youtube.com/embed/");
            frame.src = embedUrl;
        } else {
            frame.src = url;
        }

        titleElement.textContent = title;
        placeholder.style.display = 'none';
    }

    // üî∏ Carrega automaticamente a primeira aula
    document.addEventListener("DOMContentLoaded", function () {
        const firstLesson = document.querySelector("button[onclick^='loadLesson']");
        if (firstLesson) {
            firstLesson.click();
        }
    });
</script> -->
<script>
    function loadLesson(url, title, button = null) {
        const frame = document.getElementById('videoFrame');
        const titleElement = document.getElementById('lessonTitle');
        const placeholder = document.getElementById('placeholder');

        // üî∏ Reproduz o v√≠deo corretamente
        if (url.includes("youtube.com") || url.includes("youtu.be")) {
            const embedUrl = url
                .replace("watch?v=", "embed/")
                .replace("youtu.be/", "youtube.com/embed/");
            frame.src = embedUrl;
        } else {
            frame.src = url;
        }

        titleElement.textContent = title;
        placeholder.style.display = 'none';

        // üî∏ Remove destaque anterior
        document.querySelectorAll('.lesson-active').forEach(btn => {
            btn.classList.remove('bg-orange-100', 'border-l-4', 'border-orange-500', 'lesson-active');
        });

        // üî∏ Adiciona destaque ao bot√£o atual
        if (button) {
            button.classList.add('bg-orange-100', 'border-l-4', 'border-orange-500', 'lesson-active');
        }
    }

    // üî∏ Ao carregar a p√°gina, seleciona a primeira li√ß√£o
    document.addEventListener("DOMContentLoaded", function () {
        const firstLesson = document.querySelector("button[onclick^='loadLesson']");
        if (firstLesson) {
            // Marca visualmente a primeira li√ß√£o
            firstLesson.classList.add('lesson-active', 'bg-orange-100', 'border-l-4', 'border-orange-500');
            
            // Dispara o clique normalmente ‚Äî YouTube aceita porque √© dentro do fluxo DOMContentLoaded
            const onclickAttr = firstLesson.getAttribute('onclick');
            if (onclickAttr) {
                eval(onclickAttr);
            }
        }

        // Adiciona a marca√ß√£o visual ao clicar em qualquer li√ß√£o
        document.querySelectorAll("button[onclick^='loadLesson']").forEach(btn => {
            btn.addEventListener("click", function () {
                document.querySelectorAll('.lesson-active').forEach(b => {
                    b.classList.remove('bg-orange-100', 'border-l-4', 'border-orange-500', 'lesson-active');
                });
                this.classList.add('lesson-active', 'bg-orange-100', 'border-l-4', 'border-orange-500');
            });
        });
    });
</script>

{% endblock %}